<!DOCTYPE html>
<html lang="en">

  <!-- Head -->
  <head>    <!-- Metadata, OpenGraph and Schema.org -->
    

    <!-- Standard metadata -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Jannik  ZÃ¼rn | SPH Fluid Simulation</title>
    <meta name="author" content="Jannik  ZÃ¼rn" />
    <meta name="description" content="A 3D Fluid Simulation with Fortran90!" />
    <meta name="keywords" content="jannik zÃ¼rn, computer vision, robotics, freiburg, ai, ml" />


    <!-- Bootstrap & MDB -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha256-DF7Zhf293AJxJNTmh5zhoYYIMs2oXitRfBjY+9L//AY=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/css/mdb.min.css" integrity="sha256-jpjYvU3G3N6nrrBwXJoVEYI/0zw8htfFnhT9ljN3JJw=" crossorigin="anonymous" />

    <!-- Fonts & Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.15.4/css/all.min.css" integrity="sha256-mUZM63G8m73Mcidfrv5E+Y61y7a12O5mW4ezU3bxqW4=" crossorigin="anonymous">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/academicons@1.9.1/css/academicons.min.css" integrity="sha256-i1+4qU2G2860dGGIOJscdC30s9beBXjFfzjWLjBRsBg=" crossorigin="anonymous">
    <link rel="stylesheet" type="text/css" href="https://fonts.googleapis.com/css?family=Roboto:300,400,500,700|Roboto+Slab:100,300,400,500,700|Material+Icons">

    <!-- Code Syntax Highlighting -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/github.css" media="none" id="highlight_theme_light" />

    <!-- Styles -->
    
    <link rel="shortcut icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ¤–</text></svg>">
    
    <link rel="stylesheet" href="/assets/css/main.css">
    <link rel="canonical" href="https://jzuern.github.io/projects/sph/">
    
    <!-- Dark Mode -->
    
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/jwarby/jekyll-pygments-themes@master/native.css" media="none" id="highlight_theme_dark" />

    <script src="/assets/js/theme.js"></script>
    <script src="/assets/js/dark_mode.js"></script>
    

  </head>

  <!-- Body -->
  <body class="fixed-top-nav ">

    <!-- Header -->
    <header>

      <!-- Nav Bar -->
      <nav id="navbar" class="navbar navbar-light navbar-expand-sm fixed-top">
        <div class="container">
          <a class="navbar-brand title font-weight-lighter" href="https://jzuern.github.io/"><span class="font-weight-bold">Jannik</span>   ZÃ¼rn</a>
          <!-- Navbar Toggle -->
          <button class="navbar-toggler collapsed ml-auto" type="button" data-toggle="collapse" data-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
            <span class="sr-only">Toggle navigation</span>
            <span class="icon-bar top-bar"></span>
            <span class="icon-bar middle-bar"></span>
            <span class="icon-bar bottom-bar"></span>
          </button>

          <div class="collapse navbar-collapse text-right" id="navbarNav">
            <ul class="navbar-nav ml-auto flex-nowrap">

              <!-- About -->
              <li class="nav-item ">
                <a class="nav-link" href="/">about</a>
              </li>
              
              <!-- Blog -->
              <li class="nav-item ">
                <a class="nav-link" href="/blog/">blog</a>
              </li>

              <!-- Other pages -->
              <li class="nav-item ">
                <a class="nav-link" href="/projects/">Projects</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/publications/">Publications</a>
              </li>
              <li class="nav-item ">
                <a class="nav-link" href="/teaching/">Teaching</a>
              </li>

              <!-- Toogle theme mode -->
              <div class="toggle-container">
                <a id="light-toggle">
                  <i class="fas fa-moon"></i>
                  <i class="fas fa-sun"></i>
                </a>
              </div>
            </ul>
          </div>
        </div>
      </nav>
    </header>

    <!-- Content -->
    <div class="container mt-5">
      <!-- page.html -->
        <div class="post">

          <header class="post-header">
            <h1 class="post-title">SPH Fluid Simulation</h1>
            <p class="post-description">A 3D Fluid Simulation with Fortran90!</p>
          </header>

          <article>
            <h1 id="fortran-3d-sph-fluid-simulation">Fortran 3D SPH Fluid Simulation</h1>

<p>Fortran 3D fluid simulation, based on Smoothed-Particle-Hydrodynamics (SPH) with an  implementation of a Linked Cells Algorithm.</p>

<h2 id="dependencies">Dependencies</h2>

<p>We need openMP to be installed on the system in order to link to the openMP libraries.
If you do not wish to parallelize, simply remove the <code class="language-plaintext highlighter-rouge">-lopenmp</code> linker flag.</p>

<p>We use <a href="http://gnuplotfortran.sourceforge.net/" target="_blank" rel="noopener noreferrer">gnuplotfortran</a> to invoke a <a href="http://www.gnuplot.info/" target="_blank" rel="noopener noreferrer">Gnuplot</a> session from within Fortran.
Installation guidelines for these libraries can be found on the respective websites.</p>

<p>You can link to the gnuplotfortran libraries either by adding the <code class="language-plaintext highlighter-rouge">.so</code> files to your <code class="language-plaintext highlighter-rouge">LD_LIBRARY_PATH</code> or by copying the  <code class="language-plaintext highlighter-rouge">.so</code> and  <code class="language-plaintext highlighter-rouge">.mod</code> fles into the project folder.</p>

<p>The linker flags for gnuplotfortran are <code class="language-plaintext highlighter-rouge">-lfortranposix</code> and <code class="language-plaintext highlighter-rouge">-lgnuplotfortran</code>.</p>

<h2 id="build-process">Build process</h2>

<p>build the program with the provided MAKEFILE using the make command:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ make
</code></pre></div></div>

<h2 id="usage">Usage</h2>

<p>Start the simulation by executing <code class="language-plaintext highlighter-rouge">program</code> with a simulation parameter file as the command line argument
i.e.:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./program sim_setup.dat
</code></pre></div></div>

<p>After the simulation has ended you may plot the particle data in all its glory by running the bash script:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ ./plot_data3d.sh
</code></pre></div></div>

<h2 id="explanation">Explanation</h2>

<p>This 3D SPH fluid simulation is loosely based on an <a href="http://www.cs.cornell.edu/~bindel/class/cs5220-f11/code/sph.pdf" target="_blank" rel="noopener noreferrer">introductory paper</a> on this matter. I used the provided code fragments as an inspiration for my own implementation.</p>

<p>Additionally, I implemented a linked lists based approach in order to account for the quadratic time complexity depending on the particle count.</p>

<p>The simulation setup introduces a particle cloud (liquid blob) that is falling downwards due to gravitational forces. I also implemented a rotating structure (call it a watermill) in the center of the simulation domain. This structure causes the blob to disperse and break up.</p>

<p>The code within the source files is structured in a way that represents its in the simulation.
Below, we have the list of source files:</p>

<ul>
  <li>
<code class="language-plaintext highlighter-rouge">gnufor2.f90</code>: interface to call for a Gnuplot instance from within the FORTRAN program</li>
  <li>
<code class="language-plaintext highlighter-rouge">integrate.f90</code>: implementation of the leapfrog integration method</li>
  <li>
<code class="language-plaintext highlighter-rouge">linkedlist.f90</code>: implementation of linked list bookkeeping routines</li>
  <li>
<code class="language-plaintext highlighter-rouge">sphfunctions:f90</code>: implementation of particle interaction routines</li>
  <li>
<code class="language-plaintext highlighter-rouge">util.f90</code>: auxiliary functions</li>
  <li>
<code class="language-plaintext highlighter-rouge">program.f90</code>: main program which starts simulation and contains the simulation loop</li>
</ul>

<p>Additionally commentary is provided along the code within the source files.</p>

<p>In order to plot the particle data that has been written to file, I suggest using the provided bash script <code class="language-plaintext highlighter-rouge">plot_data3d.sh</code> which starts Gnuplot and plots the contents of the <code class="language-plaintext highlighter-rouge">data</code> folder. You might need to edit the script to make it suit your plotting needs. You also might want to make the bash script executable by typing</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>$ chmod +x plot_data3d.sh
</code></pre></div></div>

<h2 id="visualization">Visualization</h2>

<p><a href="http://gnuplotfortran.sourceforge.net/" target="_blank" rel="noopener noreferrer">Gnuplotfortran</a> for on-line visualization of the particle cloud for debugging and quick observation purposes. This library is rather buggy and relies on kernel ICP and fortranposix (implementation of POSIX functions in Fortran 90 &amp; 95). It is only intened for on-line quick glances at the ongoing simulation to see if something is going wrong.</p>

<p>If, you wish to visualize to data that has been written to file during the simulation, once the simulation has terminated, you may use the provided bash script <code class="language-plaintext highlighter-rouge">plot_data3d.sh</code> to plot the particle data contained in those files.</p>

<h2 id="simulation-parameters">Simulation parameters</h2>

<p>Command line argument to parameter file <code class="language-plaintext highlighter-rouge">sim_setup.dat</code>
This file is read using FORTRANâ€™s namelist routine</p>

<p>Exemplary parameters for fluid behavior similar to water are:</p>
<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>&amp;SIMPARAMETER
nframes=200              ! Number of frames
nSteps_per_frame=50      ! Number of steps per frame. Default: 50
h=0.02                  ! Size of particles (radius). Also: Distance of particles in initial configuration
dt=1.0E-4                ! Time step size. Default: 1E-4
rho0=1.0E4               ! Reference density Default: 10000
k=1.0E6                  ! Bulk modulus. Default: 1000
mu=0.001                 ! Viscosity. Default: 0.1
g=9.81                   ! gravity strength. Default: 9.81
rcut_x=0.025             ! cell cutoff radius in x-direction (as fraction of total size of simulation grid)
rcut_y=0.025             ! cell cutoff radius in y-direction (as fraction of total size of simulation grid)
rcut_z=0.025             ! cell cutoff radius in z-direction (as fraction of total size of simulation grid)
mill=.TRUE.              ! Decide whether a watermill is in the computational domain or not
dphi=-0.0004             ! rotation speed of watermill (only applicable if mill == .true.)
/

</code></pre></div></div>
<p>Create a sim_setup.dat file in your working directory and copy those lines into it.
(or use the provided file)</p>

<h2 id="screenshots">Screenshots</h2>

<p><img src="/assets/img/sph/1.jpg" alt="1">
<img src="/assets/img/sph/2.jpg" alt="2">
<img src="/assets/img/sph/3.jpg" alt="3"></p>

          </article>

        </div>

    </div>

    <!-- Footer -->    
    <footer class="fixed-bottom">
      <div class="container mt-0">
        Â© Copyright 2022 Jannik  ZÃ¼rn. Powered by <a href="https://jekyllrb.com/" target="_blank" rel="noopener noreferrer">Jekyll</a> with <a href="https://github.com/alshedivat/al-folio" target="_blank" rel="noopener noreferrer">al-folio</a> theme. Hosted by <a href="https://pages.github.com/" target="_blank" rel="noopener noreferrer">GitHub Pages</a>.

      </div>
    </footer>

    <!-- JavaScripts -->
    <!-- jQuery -->
  <script src="https://cdn.jsdelivr.net/npm/jquery@3.6.0/dist/jquery.min.js" integrity="sha256-/xUj+3OJU5yExlq6GSYGSHk7tPXikynS7ogEvDej/m4=" crossorigin="anonymous"></script>

    <!-- Bootsrap & MDB scripts -->
  <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.2/dist/umd/popper.min.js" integrity="sha256-l/1pMF/+J4TThfgARS6KwWrk/egwuVvhRzfLAMQ6Ds4=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.6.1/dist/js/bootstrap.min.js" integrity="sha256-SyTu6CwrfOhaznYZPoolVw2rxoY7lKYKQvqbtqN93HI=" crossorigin="anonymous"></script>
  <script src="https://cdn.jsdelivr.net/npm/mdbootstrap@4.20.0/js/mdb.min.js" integrity="sha256-NdbiivsvWt7VYCt6hYNT3h/th9vSTL4EDWeGs5SN3DA=" crossorigin="anonymous"></script>

    <!-- Masonry & imagesLoaded -->
  <script defer src="https://cdn.jsdelivr.net/npm/masonry-layout@4.2.2/dist/masonry.pkgd.min.js" integrity="sha256-Nn1q/fx0H7SNLZMQ5Hw5JLaTRZp0yILA/FRexe19VdI=" crossorigin="anonymous"></script>
  <script defer src="https://cdn.jsdelivr.net/npm/imagesloaded@4/imagesloaded.pkgd.min.js"></script>
  <script defer src="/assets/js/masonry.js" type="text/javascript"></script>
    
  <!-- Medium Zoom JS -->
  <script src="https://cdn.jsdelivr.net/npm/medium-zoom@1.0.6/dist/medium-zoom.min.js" integrity="sha256-EdPgYcPk/IIrw7FYeuJQexva49pVRZNmt3LculEr7zM=" crossorigin="anonymous"></script>
  <script src="/assets/js/zoom.js"></script><!-- Load Common JS -->
  <script src="/assets/js/common.js"></script>

    <!-- MathJax -->
  <script type="text/javascript">
    window.MathJax = {
      tex: {
        tags: 'ams'
      }
    };
  </script>
  <script defer type="text/javascript" id="MathJax-script" src="https://cdn.jsdelivr.net/npm/mathjax@3.2.0/es5/tex-mml-chtml.js"></script>
  <script defer src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>

    
  </body>
</html>

